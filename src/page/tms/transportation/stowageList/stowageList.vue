<template>
  <layout-body>
    <div slot="top-form">
      <!--  主页面top表单   -->
      <zhqc-top-form
        :ref-obj.sync="topForm.ref"
        :data="topForm.data"
        :field-list="topForm.fieldList"
        :rules="topForm.rules"
        :list-type-info="listTypeInfo"
        :label-width="topForm.labelWidth"
        @handleClick="handleClick"
        @handleEvent="handleEvent"
      >
        <!--        货主-->
        <template v-slot:form-ownerName>
          <remote-list
            :model="topForm.data"
            select-key="ownerCode"
            parame-code="ownerCode"
            lable="ownerName"
            :code="'ownerCode'"
            :list-url="ownerUrl"
          >
            <template v-slot="scope">
              <span style="float: left; color: #8492a6; font-size: 13px;">{{ scope.item.ownerName }}</span>
            </template>
          </remote-list>
        </template>
        <!--        发货-->
        <template v-slot:form-senderName>
          <list-sender-or-receiver
            :model="topForm.data"
            select-key="senderName"
            lable="senderName"
            parame-code="senderCode"
            :list-url="SRUrl"
            :param-type="true"
          />
        </template>
        <!--        收货-->
        <template v-slot:form-receiverName>
          <list-sender-or-receiver
            :model="topForm.data"
            select-key="receiverName"
            lable="receiverName"
            parame-code="receiverCode"
            :list-url="SRUrl"
            :param-type="true"
          />
        </template>
        <!--        承运商-->
        <template v-slot:form-carrierName>
          <list-carrierName
            :model="topForm.data"
            select-key="carrierName"
            lable="carrierName"
            parame-code="carrierCode"
          />
        </template>
        <template v-slot:form-sys="" class="el-icon-test">
          <el-button
            type="primary"
            icon="el-icon-search"
            @click="handleClick('search')"
          >{{ $t("table.search") }}</el-button>
          <el-button
            type="warning"
            icon="el-icon-refresh-left"
            @click="handleClick('reboot')"
          >{{ $t("table.reboot") }}</el-button>
          <div class="collapsable-item" @click="handleClick('openCollapsable')">
            {{ collapsable ? "收起" : "展开"
            }}<i
              :class="collapsable ? 'el-icon-arrow-up' : 'el-icon-arrow-down'"
            />
          </div>
        </template>
      </zhqc-top-form>
    </div>
    <div slot="left-btn">
      <!--      <el-button-group>-->
      <!--        <el-button icon="el-icon-truck" type="success">配载装车</el-button>-->
      <!--      </el-button-group>-->
      <el-button-group>
        <el-button icon="el-icon-truck" type="success" :disabled="disabledQ" @click="quickIn">一键装车</el-button>
      </el-button-group>
      <el-button-group>
        <el-button icon="el-icon-sold-out" type="danger" :disabled="disabledQ" @click="quickOut">一键卸货</el-button>
      </el-button-group>
      <!--      <el-button-group>-->
      <!--        <el-button icon="el-icon-printer" type="primary">打印</el-button>-->
      <!--      </el-button-group>-->
    </div>

    <div slot="tab-body" class="tab-body_auto">
      <!--  主页面的table表格  -->
      <zhqc-table
        :data.sync="resp"
        :field-list="tableInfo.fieldList"
        :handle="tableInfo.handle"
        :selectable="selectable"
        @handleClick="handleClick"
        @handleEvent="handleEvent"
      >
        <template v-slot:bt-slotEvent="scope">
          <el-button type="success" :disabled="scope.data.row.assignStatus === 4" @click="confirmAssign(scope.data.row)">确认发运</el-button>
          <el-button type="danger" :disabled="scope.data.row.assignStatus === 4" @click="cancelAssign(scope.data.row)">取消配载</el-button>
        </template>
      </zhqc-table>
    </div>

    <div slot="bottom-page">
      <!--  分页组件   -->
      <zhqc-page
        :total="total"
        :page-request="pageRequest"
        @pageChange="pageChange"
      />
    </div>
    <!--      取消配载-->
    <zhqc-dialog
      :title="dialogInfo.title"
      :visible.sync="dialogInfo.visible"
      :width="dialogInfo.width"
      :bt-list="dialogInfo.btList"
      @handleClick="handleClick"
    >
      <zhqc-form
        :ref-obj.sync="diaFormInfo.ref"
        :data="diaFormInfo.data"
        :field-list="diaFormInfo.fieldList"
        :rules="diaFormInfo.rules"
        :list-type-info="listTypeInfo"
        :label-width="diaFormInfo.labelWidth"
      >
        <template v-slot:form-cancel>
          <upload-file
            ref="uploadImg"
            :show-tips="true"
            :export-url="exportImgUrl"
            :img-pre-src-list="fileList"
            @handleImgSuccess="handleImgFn"
            @handleRemove="handleImgFn"
          />
        </template>
      </zhqc-form>
    </zhqc-dialog>
  </layout-body>
</template>

<script>
import { VUE_APP_BASE_URL } from '@/api/api.config.js'
import { VUE_APP_WMS_MODEL } from '@/api/api.config.js'
import stowageListMixins from './mixins'
export default {
  name: 'StowageList',
  components: {
    listCarrierName: () => import('@/Subassembly/ZhqcList/ListCarrierNameSc'),
    ListSenderOrReceiver: () => import('@/Subassembly/ZhqcList/ListSenderOrReceiver'),
    uploadFile: () => import('@/Subassembly/upload/upload')
  },
  mixins: [stowageListMixins],
  data() {
    return {
      store: 'stowageList/',
      modName: 'stowageList',
      pageRequest: { limit: this.$globalLimit, page: this.$globalPage },
      dialogInfo: {
        width: '420px',
        title: '',
        visible: false,
        type: '',
        btList: [
          { label: this.$t('table.close'), type: '', icon: '', event: 'close', show: true },
          { label: this.$t('table.save'), type: 'primary', icon: '', event: 'save', btLoading: false, show: true }]
      },
      collapsable: false,
      imgPreSrcList: [],
      fileList: [],
      evidenceList: [],
      exportImgUrl: VUE_APP_BASE_URL + 'fileMgr/fileManager/upload2Path',
      ownerUrl: VUE_APP_WMS_MODEL + '/base/partner/owner/queryOwnerCbList',
      orderReqUrl: '/base/partner/factory/querySenderOrReceiverList',
      // 收获方 发货方 查询全部
      SRUrl: VUE_APP_WMS_MODEL + '/base/search/customerList',
      disabledQ: true,
      tableSelected: []
    }
  },
  computed: {
    resp() { return this.$store.state[this.modName].pageResp },
    total() { return this.$store.state[this.modName].total }
  },
  watch: {
    // 监听弹窗的状态 清除校验与初始化字段
    'dialogInfo.visible'(val) {
      const diaFormInfo = this.diaFormInfo
      if (!val) {
        if (diaFormInfo.ref) {
          diaFormInfo.ref.resetFields()
        }
        this.resetFormData()
      }
    },
    // 展开收缩
    collapsable(val) {
      //
      if (val) {
        this.collapsableFormMore()
      } else {
        this.collapsableForm()
      }
    }
  },
  methods: {
    selectable(row) {
      return row.assignStatus !== 4
    },
    // 添加展开收起表单功能
    openCollapsable() {
      this.collapsable = !this.collapsable
    },
    handleImgFn(fileList) {
      this.evidenceList = fileList.map(item => ({
        type: item.endsWith('.pdf') ? 2 : 1,
        path: item
      }))
    }
  }
}
</script>
